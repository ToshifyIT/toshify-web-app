# CI/CD Pipeline Lineal
# BUILD â†’ APPROVAL STAGING â†’ PR STAGING â†’ APPROVAL PROD â†’ PR MAIN

name: CI/CD Pipeline

on:
  push:
    branches: [development]

permissions:
  contents: write
  pull-requests: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PASO 1: Build & Validate
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: "1. Build"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx tsc --noEmit
      - run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PASO 2: AprobaciÃ³n para Staging
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  approval-staging:
    name: "2. Approval Staging"
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: staging
    steps:
      - run: echo "âœ… Aprobado para Staging"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PASO 3: Crear PR a Staging
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pr-staging:
    name: "3. PR Staging"
    needs: approval-staging
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Crear PR development â†’ staging
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Verificar si ya existe un PR abierto
          EXISTING_PR=$(gh pr list --base staging --head development --state open --json number -q '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "âœ… PR #$EXISTING_PR ya existe"
            echo "ğŸ”— https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
          else
            gh pr create \
              --base staging \
              --head development \
              --title "ğŸš€ Deploy to Staging" \
              --body "## Cambios desde Development

          Este PR fue creado automÃ¡ticamente por el pipeline CI/CD.

          ### âœ… Verificaciones completadas:
          - Build exitoso
          - TypeScript sin errores
          - AprobaciÃ³n de staging recibida

          ### ğŸ“‹ Para aprobar:
          1. Revisar los cambios
          2. Aprobar el PR
          3. Merge para continuar el pipeline

          ---
          ğŸ¤– Generado automÃ¡ticamente por CI/CD Pipeline"

            echo "âœ… PR creado exitosamente"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PASO 4: AprobaciÃ³n para ProducciÃ³n
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  approval-production:
    name: "4. Approval Prod"
    needs: pr-staging
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - run: echo "âœ… Aprobado para ProducciÃ³n"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PASO 5: Crear PR a Main
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  pr-main:
    name: "5. PR Main"
    needs: approval-production
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Crear PR staging â†’ main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Verificar si ya existe un PR abierto
          EXISTING_PR=$(gh pr list --base main --head staging --state open --json number -q '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "âœ… PR #$EXISTING_PR ya existe"
            echo "ğŸ”— https://github.com/${{ github.repository }}/pull/$EXISTING_PR"
          else
            gh pr create \
              --base main \
              --head staging \
              --title "ğŸš€ Deploy to Production" \
              --body "## Cambios desde Staging

          Este PR fue creado automÃ¡ticamente por el pipeline CI/CD.

          ### âœ… Verificaciones completadas:
          - Build exitoso
          - TypeScript sin errores
          - AprobaciÃ³n de staging recibida
          - AprobaciÃ³n de producciÃ³n recibida

          ### ğŸ“‹ Para desplegar:
          1. Revisar los cambios
          2. Aprobar el PR
          3. Merge â†’ Dokploy desplegarÃ¡ automÃ¡ticamente

          ---
          ğŸ¤– Generado automÃ¡ticamente por CI/CD Pipeline"

            echo "âœ… PR creado exitosamente"
            echo "ğŸš€ Al hacer merge, Dokploy desplegarÃ¡ automÃ¡ticamente"
          fi
